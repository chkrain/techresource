<div class="order-details-expanded">
    <div class="details-section">
        <h4>üì¶ –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ #{{ order.id }}</h4>
        
        <div class="details-grid">
            <div class="detail-group">
                <h5>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h5>
                <div class="detail-item">
                    <span class="detail-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
                    <span class="detail-value">{{ order.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="detail-value">{{ order.get_status_display }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</span>
                    <span class="detail-value">{{ order.get_payment_method_display }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–û–±—â–∞—è —Å—É–º–º–∞:</span>
                    <span class="detail-value">{{ order.total_price }} ‚ÇΩ</span>
                </div>
                {% if order.paid_at %}
                <div class="detail-item">
                    <span class="detail-label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã:</span>
                    <span class="detail-value">{{ order.paid_at|date:"d.m.Y H:i" }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="detail-group">
                <h5>üë§ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</h5>
                <div class="detail-item">
                    <span class="detail-label">–ò–º—è:</span>
                    <span class="detail-value">{{ order.customer_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span class="detail-value">{{ order.customer_phone }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{ order.customer_email }}</span>
                </div>
            </div>
            
            <div class="detail-group">
                <h5>üöö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ</h5>
                <div class="detail-item">
                    <span class="detail-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                    <span class="detail-value">{{ order.delivery_address|linebreaksbr }}</span>
                </div>
                {% if order.tracking_number %}
                <div class="detail-item">
                    <span class="detail-label">–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä:</span>
                    <span class="detail-value">{{ order.tracking_number }}</span>
                </div>
                {% endif %}
                {% if order.shipping_company %}
                <div class="detail-item">
                    <span class="detail-label">–°–ª—É–∂–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                    <span class="detail-value">{{ order.shipping_company }}</span>
                </div>
                {% endif %}
                {% if order.estimated_delivery %}
                <div class="detail-item">
                    <span class="detail-label">–ü—Ä–∏–º–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                    <span class="detail-value">{{ order.estimated_delivery|date:"d.m.Y" }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="detail-group">
                <h5>üìä –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤</h5>
                <div class="status-history">
                    {% for log in status_logs %}
                    <div class="status-history-item">
                        <span class="status-date">{{ log.changed_at|date:"d.m.Y H:i" }}</span>
                        <span class="status-change">
                            {{ log.get_old_status_display }} ‚Üí {{ log.get_new_status_display }}
                        </span>
                        {% if log.changed_by %}
                        <span class="status-changed-by">({{ log.changed_by.username }})</span>
                        {% endif %}
                        {% if log.notes %}
                        <div class="status-notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: {{ log.notes }}</div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="no-history">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="details-section">
            <h5>üõçÔ∏è –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h5>
            <div class="order-items-detailed">
                {% for item in order_items %}
                <div class="order-item-detailed">
                    <div class="item-image">
                        {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="no-image" style="display: none;">üì∑</div>
                        {% else %}
                        <div class="no-image">üì∑</div>
                        {% endif %}
                    </div>
                    <div class="item-info-detailed">
                        <div class="item-name">{{ item.product.name }}</div>
                        <div class="item-article">–ê—Ä—Ç–∏–∫—É–ª: {{ item.product.article }}</div>
                        <div class="item-specs">
                            {% if item.product.brand %}–ë—Ä–µ–Ω–¥: {{ item.product.brand }}{% endif %}
                            {% if item.product.material %} | –ú–∞—Ç–µ—Ä–∏–∞–ª: {{ item.product.material }}{% endif %}
                        </div>
                        <div class="item-price">–¶–µ–Ω–∞: {{ item.price }} ‚ÇΩ</div>
                    </div>
                    <div class="item-quantity-detailed">
                        √ó{{ item.quantity }}
                    </div>
                    <div class="item-total-detailed">
                        {{ item.get_total_price }} ‚ÇΩ
                    </div>
                </div>
                {% endfor %}
                
                <div class="order-total-detailed">
                    <div class="total-label">–ò—Ç–æ–≥–æ:</div>
                    <div class="total-amount">{{ order.total_price }} ‚ÇΩ</div>
                </div>
            </div>
        </div>
        
        {% if order.status == 'shipped' and order.tracking_number %}
        <div class="details-section">
            <h5>üöö –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å—ã–ª–∫–∏</h5>
            <div class="tracking-actions">
                <button class="action-btn track-external-btn" 
                        data-tracking="{{ order.tracking_number }}"
                        onclick="trackPackage('{{ order.tracking_number }}', '{{ order.shipping_company }}')">
                    üìç –û—Ç—Å–ª–µ–¥–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ —Å–ª—É–∂–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function trackPackage(trackingNumber, shippingCompany) {
    // –ë–∞–∑–æ–≤—ã–µ URL –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª—É–∂–±–∞—Ö –¥–æ—Å—Ç–∞–≤–∫–∏
    const trackingUrls = {
        '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏': `https://www.pochta.ru/tracking#${trackingNumber}`,
        '–°–î–≠–ö': `https://www.cdek.ru/ru/tracking/?order_id=${trackingNumber}`,
        'Boxberry': `https://boxberry.ru/tracking/${trackingNumber}`,
        'DPD': `https://dpd.ru/tracking/${trackingNumber}`,
        'default': `https://www.pochta.ru/tracking#${trackingNumber}`
    };
    
    const url = trackingUrls[shippingCompany] || trackingUrls.default;
    window.open(url, '_blank');
}
</script>